<script>
      function wrappedEval(textExpression, contextData) {
        let fn = Function(
          `"use strict"; 
           var data = this; 
           return (${textExpression})`
        );
        return fn.bind(contextData)();
      }

      const MAPBOX_ACCESS_TOKEN = "pk.eyJ1IjoiY3diZWFzbGV5IiwiYSI6ImNtYmE3cDhwcjAzNGQycnNhYWFwem0zNWsifQ.IpKDT3XxpNAbvwc8ovez3w";

      const urlParams = new URLSearchParams(window.location.search);
      const pullKey = urlParams.get("key"); 

      const specificFormat = "${ data.secondary_address && data.secondary_address.text ? data.secondary_address.text + ', ' : '' }${ data.address && data.address.text ? data.address.text + ', ' : '' }${ data.neighborhood && data.neighborhood.text ? data.neighborhood.text + ', ' : '' }${ data.locality && data.locality.text ? data.locality.text + ', ' : '' }${ data.place && data.place.text ? data.place.text : '' }";
      const specificLang = "en";
      
      const featureTypesForAPI = ["address", "secondary_address", "neighborhood", "locality", "place", "district", "region", "postcode", "country"];
      const featureTypesForAPIString = featureTypesForAPI.join(',');
      
      const featureParamsToExtract = [
          "secondary_address", "address", "neighborhood", "locality", "place", 
          "district", "region", "postcode", "country"
      ];

      let lastGeocodeTime = 0;
      const geocodeInterval = 1500; 
      const textElement = document.getElementById("text");

      console.log("Script loaded. Pull key from URL:", pullKey); // Check if pullKey is read

      if (!pullKey) {
        textElement.innerText = "Error: Key missing from URL.";
        console.error("Pull key is missing from URL parameters.");
      } else {
        console.log("Attempting to set up RealtimeIRL listener for key:", pullKey);
        RealtimeIRL.forPullKey(pullKey).addLocationListener(function (location) {
          // **** ADDED THIS LOG ****
          console.log("--- Location listener fired --- Location object:", JSON.stringify(location, null, 2)); 

          const currentTime = new Date().getTime();
          
          if (currentTime - lastGeocodeTime > geocodeInterval) {
            lastGeocodeTime = currentTime; 

            const lon = location.longitude;
            const lat = location.latitude;

            // Defensive check for valid coordinates
            if (typeof lat !== 'number' || typeof lon !== 'number' || isNaN(lat) || isNaN(lon)) {
                console.error("Invalid location data received:", location);
                textElement.innerText = "Invalid GPS Data";
                return;
            }

            const apiUrl = `https://api.mapbox.com/search/geocode/v6/reverse?longitude=${lon}&latitude=${lat}&types=${featureTypesForAPIString}&language=${specificLang}&access_token=${MAPBOX_ACCESS_TOKEN}`;
            
            console.log("Requesting Mapbox URL:", apiUrl); // Log the URL to ensure it's formed

            fetch(apiUrl)
                .then(async response => { 
                    const responseText = await response.text(); 
                    console.log("Mapbox API - Status:", response.status, "Raw Response Text:", responseText); 

                    if (!response.ok) {
                        let errorMsg = `HTTP error ${response.status}: `;
                        try {
                            const errorData = JSON.parse(responseText); 
                            errorMsg += (errorData.message || responseText.substring(0, 200));
                        } catch (e) {
                            errorMsg += responseText.substring(0, 200);
                        }
                        throw new Error(errorMsg); 
                    }
                    try {
                        const jsonData = JSON.parse(responseText);
                        return jsonData; 
                    } catch (e) {
                        console.error("Mapbox API Response (2xx) - FAILED TO PARSE TEXT AS JSON. Error:", e.message);
                        throw new Error(`Received 2xx status, but response text was not valid JSON. Preview: ${responseText.substring(0, 200)}`);
                    }
                })
                .then(data => { 
                    var context = {};
                    // console.log("Mapbox API v6 Data for Context Processing:", JSON.stringify(data, null, 2));

                    if (data && data.features) {
                        for (const param of featureParamsToExtract) {
                            const foundFeature = data.features.find(
                                (feature) => feature.properties && feature.properties.feature_type === param
                            );
                            if (foundFeature && foundFeature.properties && foundFeature.properties.name) {
                                context[param] = { text: foundFeature.properties.name, ...foundFeature.properties };
                            }
                        }
                        if (data.features.length > 0 && data.features[0].properties && data.features[0].properties.context) {
                            const mainFeatureContext = data.features[0].properties.context;
                            for (const param of featureParamsToExtract) {
                                if (!context[param] && mainFeatureContext[param] && mainFeatureContext[param].name) {
                                    context[param] = { text: mainFeatureContext[param].name, ...mainFeatureContext[param] };
                                }
                            }
                        }
                    }
                    // console.log("Populated Context (Fetch):", context);

                    var result = wrappedEval(specificFormat, context);
                    // console.log("Raw Result from wrappedEval:", result);

                    let cleanedResult = result.trim();
                    cleanedResult = cleanedResult.replace(/^[\s,]+|[\s,]+$/g, ''); 
                    cleanedResult = cleanedResult.replace(/,(\s*,)+/g, ',');    
                    // console.log("Cleaned Result:", cleanedResult);

                    if (cleanedResult && !cleanedResult.toLocaleLowerCase().includes("undefined") && cleanedResult.replace(/,/g, "").trim() !== "") { 
                      textElement.innerText = cleanedResult;
                    } else {
                      textElement.innerText = "Location details not found";
                    }
                })
                .catch(error => {
                    console.error("Final CATCH block error (e.g. from fetch network error, or thrown error from .then):", error.message);
                    if (textElement) { 
                        textElement.innerText = "Geocoding Process Error"; 
                    }
                });
          }
        });
      }
    </script>
</body>
</html>