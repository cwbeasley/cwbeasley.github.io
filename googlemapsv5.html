<!DOCTYPE html>
<html>
<head>
    <!-- 
      IMPORTANT: Save this file with a new name, like "googlemapsv5.html",
      to ensure the browser does not use a cached, older version.
    -->
    <title>Smooth Map Navigation Overlay v5</title>
    <script src="tween.umd.js"></script>
    <script src="angles.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@rtirl/api@latest/lib/index.min.js"></script>
    <script src="https://overlays.rtirl.com/indicator.js"></script>

    <style>
        html, body {
            margin: 0!important;
            padding: 0!important;
            width: 100%!important;
            height: 100%!important;
            overflow: hidden!important;
            background-color: rgba(0, 0, 0, 0)!important;
        }

    .map-circle-wrapper {
            width: 350px!important;
            height: 350px!important;
            border-radius: 50%!important;
            overflow: hidden!important;
            border: 6px solid #4285F4!important;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4)!important;
            background-color: rgba(255, 255, 255, 0.05)!important;
        }

        #map {
            width: 100%!important;
            height: 100%!important;
            display: flex;
            align-items: center;
            justify-content: center;
        }

    .gm-style-cc,.gmnoprint {
            display: none!important;
        }
    </style>
</head>
<body>
    <div class="map-circle-wrapper">
        <div id="map"></div>
    </div>

    <script>
        // This Immediately-Invoked Function Expression (IIFE) creates a private scope
        // to prevent any conflicts with the global scope or cached scripts.
        (function() {
            'use strict';

            // --- Configuration & Global-like Variables within IIFE Scope ---
            const params = new URLSearchParams(window.location.search);
            const EMA_ALPHA = 0.3;
            const POSITION_ANIMATION_DURATION_MS = 1000;
            const BEARING_ANIMATION_DURATION_MS = 1500;
            
            let map;
            let advancedMarker;
            let currentAnimatedPosition = null;
            let previousSmoothedPosition = null;
            let previousEmaLat = null;
            let previousEmaLng = null;
            let activePositionTween = null;
            let activeBearingTween = null;

            // --- Main Initialization Function ---
            function setupGoogleMap() {
                // Using the hardcoded Map ID provided by the user.
                const mapId = "5a45ae59a3d1e20f1361b7ce"; 
                Angles.SCALE = 360;

                const initialCenter = { lat: 38.6270, lng: -90.1994 }; // St. Louis, MO
                const initialZoom = params.get("zoom") ? Number(params.get("zoom")) : 17;
                
                // Note: The 'styles' property is intentionally omitted.
                // When a 'mapId' is used, custom styles must be configured in the Google Cloud Console,
                // as they override any inline 'styles' array provided here.
                map = new google.maps.Map(document.getElementById("map"), {
                    center: initialCenter,
                    zoom: initialZoom,
                    disableDefaultUI: true,
                    mapId: mapId, // mapId is required for Advanced Markers
                    tilt: 45,
                    heading: 0
                });

                currentAnimatedPosition = map.getCenter();
                previousSmoothedPosition = { lat: currentAnimatedPosition.lat(), lng: currentAnimatedPosition.lng() };

                advancedMarker = new google.maps.marker.AdvancedMarkerElement({
                    map: map,
                    position: initialCenter,
                });

                requestAnimationFrame(animateTweens);

                const pullKey = params.get("key");
                if (pullKey) {
                    RealtimeIRL.forPullKey(pullKey).addLocationListener(handleRealtimeIRLLocation);
                } else {
                    console.warn("RealtimeIRL pull key is missing (URL parameter 'key').");
                    const mapDiv = document.getElementById("map");
                    mapDiv.innerHTML = "<p style='color:orange; text-align:center; padding: 20px;'>RealtimeIRL 'key' parameter missing from URL.</p>";
                }
            }

            // --- Animation & Helper Functions ---
            function animateTweens(time) {
                TWEEN.update(time);
                requestAnimationFrame(animateTweens);
            }

            function getSmoothedLocation(rawLat, rawLng) {
                if (typeof rawLat !== 'number' || typeof rawLng !== 'number') {
                    console.warn("Invalid raw coordinates for smoothing:", rawLat, rawLng);
                    return (previousEmaLat !== null && previousEmaLng !== null) ? { lat: previousEmaLat, lng: previousEmaLng } : null;
                }

                if (previousEmaLat === null || previousEmaLng === null) {
                    previousEmaLat = rawLat;
                    previousEmaLng = rawLng;
                } else {
                    previousEmaLat = EMA_ALPHA * rawLat + (1 - EMA_ALPHA) * previousEmaLat;
                    previousEmaLng = EMA_ALPHA * rawLng + (1 - EMA_ALPHA) * previousEmaLng;
                }
                return { lat: previousEmaLat, lng: previousEmaLng };
            }

            function handleRealtimeIRLLocation(location) {
                if (!location || typeof location.latitude !== 'number' || typeof location.longitude !== 'number') {
                    console.warn("Invalid location data received from RealtimeIRL:", location);
                    return;
                }

                const rawPosition = { lat: location.latitude, lng: location.longitude };
                const smoothedPosition = getSmoothedLocation(rawPosition.lat, rawPosition.lng);

                if (!smoothedPosition || typeof smoothedPosition.lat !== 'number' || typeof smoothedPosition.lng !== 'number') {
                    console.warn("Invalid smoothed position:", smoothedPosition);
                    return;
                }

                const newTargetLatLng = new google.maps.LatLng(smoothedPosition.lat, smoothedPosition.lng);

                // Animate Marker Position
                if (currentAnimatedPosition && newTargetLatLng) {
                    const startPosForTween = currentAnimatedPosition;
                    const endPosForTween = newTargetLatLng;

                    if (activePositionTween) { activePositionTween.stop(); }

                    const animationState = { progress: 0 };
                    activePositionTween = new TWEEN.Tween(animationState)
                        .to({ progress: 1 }, POSITION_ANIMATION_DURATION_MS)
                        .easing(TWEEN.Easing.Quadratic.Out)
                        .onUpdate(() => {
                            const interpolatedLatLng = google.maps.geometry.spherical.interpolate(startPosForTween, endPosForTween, animationState.progress);
                            if (advancedMarker && interpolatedLatLng) { advancedMarker.position = interpolatedLatLng; }
                            if (map && interpolatedLatLng) { map.moveCamera({ center: interpolatedLatLng }); }
                            currentAnimatedPosition = interpolatedLatLng;
                        })
                        .onComplete(() => {
                            currentAnimatedPosition = endPosForTween;
                            if (advancedMarker) { advancedMarker.position = endPosForTween; }
                            if (map) { map.moveCamera({ center: endPosForTween }); }
                            activePositionTween = null;
                        })
                        .start();
                } else { 
                    if (advancedMarker) { advancedMarker.position = newTargetLatLng; }
                    if (map) { map.setCenter(newTargetLatLng); }
                    currentAnimatedPosition = newTargetLatLng;
                }

                // Animate Map Bearing/Heading
                if (map && previousSmoothedPosition && (previousSmoothedPosition.lat !== smoothedPosition.lat || previousSmoothedPosition.lng !== smoothedPosition.lng)) {
                    const prevLatLngForHeading = new google.maps.LatLng(previousSmoothedPosition.lat, previousSmoothedPosition.lng);
                    let targetBearing = google.maps.geometry.spherical.computeHeading(prevLatLngForHeading, newTargetLatLng);
                    const currentMapBearing = map.getHeading() || 0;
                    const startBearingNormalized = Angles.normalize(currentMapBearing);
                    const targetBearingNormalized = Angles.normalize(targetBearing);

                    if (Math.abs(Angles.diff(startBearingNormalized, targetBearingNormalized)) > 1) {
                        const direction = Angles.shortestDirection(startBearingNormalized, targetBearingNormalized);
                        if (activeBearingTween) { activeBearingTween.stop(); }

                        const bearingState = { progress: 0 };
                        activeBearingTween = new TWEEN.Tween(bearingState)
                            .to({ progress: 1 }, BEARING_ANIMATION_DURATION_MS)
                            .easing(TWEEN.Easing.Quadratic.Out)
                            .onUpdate(() => {
                                const interpolatedBearing = Angles.lerp(startBearingNormalized, targetBearingNormalized, bearingState.progress, direction);
                                map.moveCamera({ heading: interpolatedBearing });
                            })
                            .onComplete(() => {
                                map.moveCamera({ heading: targetBearingNormalized });
                                activeBearingTween = null;
                            })
                            .start();
                    }
                }
                previousSmoothedPosition = smoothedPosition;
            }

            // --- Script Execution Logic ---
            const apiKey = params.get("api_key");

            if (!apiKey) {
                console.error("Google Maps API key is missing. Please provide it as a URL parameter: ?api_key=YOUR_KEY");
                const mapDiv = document.getElementById("map");
                mapDiv.innerHTML = "<p style='color:red; text-align:center; padding: 20px;'>Google Maps API key ('api_key') missing from URL.</p>";
                const wrapper = document.querySelector('.map-circle-wrapper');
                if (wrapper) wrapper.style.borderColor = 'red';
            } else {
                // Expose the setup function globally for the Maps API callback
                window.setupGoogleMap = setupGoogleMap;
                
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=setupGoogleMap&libraries=marker,geometry&v=beta`;
                script.defer = true;
                document.head.appendChild(script);
            }
        })();
    </script>
</body>
</html>
